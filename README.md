Документация по коду Telegram-бота
1. Введение
Этот документ описывает структуру и принципы работы Telegram-бота-калькулятора, написанного на Python с использованием библиотеки aiogram 3.x. Бот предназначен для выполнения математических вычислений в инлайн-режиме, позволяя пользователям получать результаты, не выходя из чата.

Ключевой особенностью является поддержка специальных сокращений (тикеров) для подстановки актуальных курсов валют и криптовалют в выражения.

2. Основные возможности
Инлайн-калькулятор: Выполнение математических операций прямо в любом чате Telegram.

Курсы валют: Автоматическая подстановка курсов USD, EUR, CNY к рублю по данным Центробанка РФ.

Курсы криптовалют: Подстановка курсов BTC и ETH к USDT по данным API Binance.

Производные курсы: Расчет кросс-курса EUR/USD и стоимости криптовалют в рублях.

Вычисления с процентами: Поддержка операций вида число + X% и число - X%.

Статистика использования: Сбор и отображение статистики (DAU, MAU, общее количество запросов) для администратора бота.

Многоязычная справка: Поддержка команд /help и /help_en.

3. Установка и запуск
3.1. Предварительные требования
Python 3.8+

Созданный через @BotFather Telegram-бот и его токен.

3.2. Настройка
Получите токен: Создайте нового бота у @BotFather и скопируйте полученный токен.

Включите инлайн-режим: В настройках вашего бота у @BotFather (/mybots -> Bot Settings) включите Inline Mode.

Установите зависимости: Выполните в терминале:

pip install aiogram aiohttp

Настройте переменные в коде:

BOT_TOKEN: Вставьте ваш токен.

ADMIN_ID: Укажите ваш числовой Telegram ID для доступа к команде /stats. Его можно узнать у ботов типа @userinfobot.

3.3. Запуск
Запустите скрипт из терминала: python bot_script_name.py

4. Структура кода
Скрипт логически разделен на несколько блоков:

4.1. Конфигурация
Здесь задаются основные параметры: токен бота, ID администратора, URL-адреса API и словарь TICKER_MAP, который связывает сокращения (ur, bnc) с их идентификаторами для API.

4.2. Управление статистикой
load_stats(): Загружает статистику из файла bot_stats.json.

save_stats(): Сохраняет обновленные данные в тот же файл.

update_stats(): Атомарно обновляет счетчики при каждом инлайн-запросе.

4.3. Логика получения данных
fetch_cbr_prices(): Асинхронно запрашивает и парсит XML-данные от Центробанка РФ для получения курсов фиатных валют.

get_binance_price(): Асинхронно запрашивает JSON-данные от Binance для получения курсов криптовалют.

fetch_all_prices(): Главная функция-агрегатор. Параллельно запускает запросы ко всем источникам с помощью asyncio.gather() и формирует итоговый словарь с ценами, включая расчет производных (eu, ob, oe).

4.4. Логика вычислений (evaluate_expression)
Это "сердце" калькулятора.

Вызывает fetch_all_prices() для получения актуальных курсов.

Последовательно заменяет все тикеры в строке выражения на их числовые значения.

С помощью регулярных выражений преобразует операции с процентами в стандартные математические формулы.

Проверяет итоговое выражение на наличие запрещенных символов для безопасности.

Выполняет вычисление с помощью eval() в изолированном окружении.

Форматирует результат и возвращает его в виде строки.

4.5. Обработчики команд (handlers)
send_start_and_help и send_help_en: Отправляют справку с использованием HTML-разметки.

send_stats: Проверяет ID пользователя и, если он совпадает с ADMIN_ID, отправляет статистику.

handle_other_messages: "Ловит" все текстовые сообщения, не являющиеся командами, и подсказывает пользователю, что бот работает в инлайн-режиме.

inline_handler: Основной обработчик. Срабатывает, когда пользователь вводит @имя_бота .... Он вызывает evaluate_expression и формирует ответ в виде InlineQueryResultArticle.

4.6. Главная функция (main)
Инициализирует бота и диспетчер, регистрирует все обработчики и запускает бота в режиме опроса (polling).
